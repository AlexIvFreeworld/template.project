1. Инструменты текстового редактора
- форматирование текста Edit/line/Reindent
- обновление папок Project/Refresh Folders
- поиск и замена Find/Replace...

2. Использование документации
api_d7.chm
bsm_api.chm
php_enhanced_ru.chm

3. План решения задач

[ex2-34] Установить значение тега meta «specialdate» в компоненте news.list
bsm_api.chm
[ShowProperty] (Главный модуль>Классы>CMain>ShowProperty)
[SetResultCacheKeys] (Главный модуль>Классы>CBitrixComponent>setResultCacheKeys)
[SetPageProperty] (Главный модуль>Классы>CMain>SetPageProperty)

- прописываем в header meta тег, в content выводим значение с помощью $APPLICATION->ShowProperty("specialdate")
- в админке "Управление структурой" устанавливаем тип свойства "specialdate" значение "specialdate"
- в админке "Контент/Структура сайта/Файлы и папки" открываем "Дополнительно/Свойства папки", устанавливаем specialdate = 100
- проверяем наличие вывода тега specialdate в публичной части
- копируем /bitrix/components/bitrix/news/templates/.default/.parameters.php в аналогичную /local/    
- копируем /bitrix/components/bitrix/news/templates/.default/lang/ru/.parameters.php в аналогичную /local/
- в .parameters.php добавляем копированием параметр "SPECIAL_DATE" с типом "CHECKBOX" значение "DEFAULT" => "Y"
- в /lang/ru/.parameters.php добавляем фразу название свойства которое будет выведено в параметрах компонента
- проверяем в публичной части появление этого параметра
- в файле /local/components/bitrix/news/templates/.default/news.php в вызов "bitrix:news.list" добавляем параметр "SPECIAL_DATE" => $arParams["SPECIAL_DATE"],
- проверяем наличие $arParams["SPECIAL_DATE"] в /local/components/bitrix/news/templates/.default/bitrix/news.list/.default/template.php через debug()
- добавляем в /local/components/bitrix/news/templates/.default/bitrix/news.list/.default/ Файлы result_modifier.php и component_epilog.php
- в result_modifier.php для установленного параметра SPECIAL_DATE, выбираем дату первой новости и отмечаем результат для кеширования, что бы был доступен в component_epilog
if($arParams["SPECIAL_DATE"] == "Y"){
	$arResult["DATE_FIRST_NEWS"] = $arResult["ITEMS"][0]["ACTIVE_FROM"];
	$this->__component->SetResultCacheKeys(array("DATE_FIRST_NEWS"));
}
- в component_epilog.php при наличии результата $arResult["DATE_FIRST_NEWS"], устанавливаем значение свойства specialdate 
if(isset($arResult["DATE_FIRST_NEWS"])){
	$APPLICATION->SetPageProperty("specialdate",$arResult["DATE_FIRST_NEWS"]);
}          
- проверяем наличие значения у свойства specialdate в публичной части с кешированием и без кеширования
- проверяем результат при выключенном параметре SPECIAL_DATE

------------------------------------------------------------------------------------------------------------

[ex2-108] link rel="canonical" для детальной новости 
bsm_api.chm
[CIBlockElement] [CIBlockElement::GetList]
[SetResultCacheKeys] (Главный модуль>Классы>CBitrixComponent>setResultCacheKeys)

Создаем инфоблок "Canonical" в типе инфоблоков "Новости"
В созданном информационном блоке создаем свойство Новость - NEW, тип: привязка кинформационному блоку Новости.
Добавляем элемент в инфоблок Canonical, Название http://test.ru/test/ , Привязка к новости [2] Международная мебельная выставка SALON DEL MOBILE
В админке "Управление структурой" добавляем тип свойства - canonical, значение - canonical

В local/templates/furniture_dark-blue/components/bitrix/news/.default/.parameters.php добавляем параметр, где будет указан ид инфоблока "Canonical"
	"ID_REL_CANONICAL_BLOCK" => Array(
		"NAME" => GetMessage("T_IBLOCK_DESC_NEWS_ID_REL_CANONICAL_BLOCK"),
		"TYPE" => "STRING",
		"DEFAULT" =>"",
		"REFRESH"=> "Y",
	),
$MESS["T_IBLOCK_DESC_NEWS_ID_REL_CANONICAL_BLOCK"] = "ID информационного блока для rel=canonical»";
В публичной части на http://localhost/news/ проверяем в параметрах компонента наличие параметра "ID информационного блока для rel=canonical»"
Устанавливаем значение ид инфоблока Canonical (в учебном примере - 5)	
В local/templates/furniture_dark-blue/components/bitrix/news/.default/lang/ru/.parameters.php заносим фразу 
В local/templates/furniture_dark-blue/components/bitrix/news/.default/detail.php добавляем параметр для детального компонента
"ID_REL_CANONICAL_BLOCK" => $arParams["ID_REL_CANONICAL_BLOCK"]
В local/templates/furniture_dark-blue/components/bitrix/news/.default/bitrix/news.detail/.default добавляем
result_modifier.php, component_epilog.php
В result_modifier.php получаем значение свойства NEW элемента Canonical связанное с элементом Новости и добавляем в кешируемый
$arResult для получения в эпилоге
if (!empty($arParams["ID_REL_CANONICAL_BLOCK"])) {
    $arSelect = array("ID", "IBLOCK_ID", "NAME", "PROPERTY_NEW");
    $arFilter = array("IBLOCK_ID" => IntVal($arParams["ID_REL_CANONICAL_BLOCK"]), "PROPERTY_NEW" => $arResult["ID"], "ACTIVE" => "Y");
    $res = CIBlockElement::GetList(array(), $arFilter, false, array("nPageSize" => 50), $arSelect);
    if ($ob = $res->GetNextElement()) {
        $arFields = $ob->GetFields();
        $arResult["CANONICAL_LINK"] = $arFields["NAME"];
        $this->__component->SetResultCacheKeys(array("CANONICAL_LINK"));
    }
}
В component_epilog.php устанавливаем свойство страницы
if(isset($arResult["CANONICAL_LINK"])){
    $APPLICATION->SetPageProperty("canonical",$arResult["CANONICAL_LINK"]);
}
Прим так можно делать без использования вывода в head через $APPLICATION->ShowProperty(), для типов свойств управляющих метаданными страницы
description, keywords, title, canonical

------------------------------------------------------------------------------------------------------------

[ex2-50] Проверка при деактивации товара
bsm_api.chm
[OnBeforeIBlockElementUpdate]
[CIBlockElement] [CIBlockElement::GetList]
[Loc] [Loc::getMessage]

Создадим local/php_interface/init.php, local/php_interface/include/events.php, local/php_interface/include/constants.php
Найдем в справочнике событие onBeforeIBlockElementUpdate и разместим пример в events.php
Уберем условие и заменим названия класса и метода, добавим методу public static
AddEventHandler("iblock", "OnBeforeIBlockElementUpdate", array("Ex2", "Ex2_50"));
class Ex2
{
    // создаем обработчик события "OnBeforeIBlockElementUpdate"
   public static function Ex2_50(&$arFields)
    {
        global $APPLICATION;
        $APPLICATION->throwException("Введите символьный код. (ID:" . $arFields["ID"] . ")");
        return false;
    }
}
В админке пробуем изменить элемент инфоблока, должен сработать обработчик, выдав сообщение "Введите символьный код. (ID:" . $arFields["ID"] . ")"
Посмотрим какие поля приходят echo "<pre>"; print_r($arFields); echo "</pre>";
Определим константу IBLOCK_CATALOG_ID в constants.php (ид инфоблока "Продукция") 
Добавим в обработчик отбор по ид инфоблока и активности элемента
С помощью CIBlockElement::GetList, получим поле элемента SHOW_COUNTER
    public static function Ex2_50(&$arFields)
    {
        if ($arFields["IBLOCK_ID"] == IBLOCK_CATALOG_ID) {

            if ($arFields["ACTIVE"] == "N") {
                $arSelect = array("ID", "IBLOCK_ID", "NAME", "SHOW_COUNTER");
                $arFilter = array("IBLOCK_ID" => IBLOCK_CATALOG_ID, "ID" => $arFields["ID"]);
                $res = CIBlockElement::GetList(array(), $arFilter, false, false, $arSelect);
                if ($arItem = $res->Fetch()) {
                    echo "<pre>"; print_r($arItem); echo "</pre>";
                }
                global $APPLICATION;
                // echo "<pre>"; print_r($arFields); echo "</pre>";
                $APPLICATION->throwException("Введите символьный код. (ID:" . $arFields["ID"] . ")");
                return false;
            }
        }
    }
В режиме инкогнито откроем  детальную страницу элемента (в решении "Герцог")
Проверим что бы значение поля SHOW_COUNTER было равно 3
Добавим константу define("MAX_COUNT",2);
Добавим условие вывода сообщения об ошибке, для элементов с количеством просмотров больше чем MAX_COUNT
Добавим для языковых фраз файл в соответвтвующих разделах local/php_interface/include/lang/ru/events.php
Добавим фразу $MESS["SHOW_COUNTER_TEXT"] = "Товар невозможно деактивировать у него #COUNT# просмотров";
Выведем сообщение с помощью языковой фразы
    public static function Ex2_50(&$arFields)
    {
        if ($arFields["IBLOCK_ID"] == IBLOCK_CATALOG_ID) {

            if ($arFields["ACTIVE"] == "N") {
                $arSelect = array("ID", "IBLOCK_ID", "NAME", "SHOW_COUNTER");
                $arFilter = array("IBLOCK_ID" => IBLOCK_CATALOG_ID, "ID" => $arFields["ID"]);
                $res = CIBlockElement::GetList(array(), $arFilter, false, false, $arSelect);
                $arItem = $res->Fetch();
                
                if (intval($arItem["SHOW_COUNTER"]) > MAX_COUNT) {
                    global $APPLICATION;
                    $erText = Loc::getMessage("SHOW_COUNTER_TEXT", array("#COUNT#" => $arItem["SHOW_COUNTER"]));
                    $APPLICATION->throwException($erText);
                    return false;
                }
            }
        }
    }

------------------------------------------------------------------------------------------------------------

[ex2-93] Записывать в Журнал событий открытие не существующих страниц сайта
bsm_api.chm
[OnEpilog]
[CEventLog] [CEventLog::Add]

В local/php_interface/include/events.php добавляем обработчик события OnEpilog
При условии ошибки 404 с показываем 404.php и с помощью CEventLog::Add делаем запись в Журнал событий
AddEventHandler("main", "OnEpilog", array("Ex2", "Ex2_93"));
    public static function Ex2_93()
    {
        if (defined("ERROR_404") && ERROR_404 == "Y") {
            global $APPLICATION;
            $APPLICATION->RestartBuffer();
            include $_SERVER["DOCUMENT_ROOT"] . SITE_TEMPLATE_PATH . "/header.php";
            include $_SERVER["DOCUMENT_ROOT"] . "/404.php";
            include $_SERVER["DOCUMENT_ROOT"] . SITE_TEMPLATE_PATH . "/footer.php";
            CEventLog::Add(array(
                "SEVERITY" => "INFO",
                "AUDIT_TYPE_ID" => "ERROR_404",
                "MODULE_ID" => "main",
                "DESCRIPTION" => $APPLICATION->GetCurPage()
            ));
        }
    }
В качестве проверки заходим на страницы /not_real/?not=N, /news/not_real/
Проверяем наличие записей в Журнале событий

------------------------------------------------------------------------------------------------------------

[ex2-51] Изменение данных в письме 
bsm_api.chm
[OnBeforeEventAdd]
[CUser] [CUser::IsAuthorized]
[CEventLog] [CEventLog::Add]

В публичной части создаем разделы /ex2/feedback/ с названиями /Экзамен2/Форма обратной связ/
В публичной части в разделе feedback через визуальный редактор устанавливаем компонент "Форма обратной связи"
В local/php_interface/include/events.php добавляем обработчик события OnBeforeEventAdd методом Ex2_51
Проверяем входящие параметры с отправки формы
AddEventHandler("main", "OnBeforeEventAdd", array("Ex2", "Ex2_51"));
 public static    function Ex2_51(&$event, &$lid, &$arFields)
    {
        echo "<pre>"; print_r($event); echo "</pre>";
        echo "<pre>"; print_r($lid); echo "</pre>";
        echo "<pre>"; print_r($arFields); echo "</pre>";
        die();
    }
Для события FEEDBACK_FORM проверяем пользователя на наличие авторизации
Формируем новое значение поля $arFields["AUTHOR"] для авторизованного и неавторизованного пользователя
С помощью CEventLog::Add делаем запись в Журнале событий
Отправляем форму от авторизованного и неавторизованного пользователя
Проверяем наличие записи в Журнале событий
Проверяем поле AUTHOR на соответствие задаче запросом к базе SELECT * FROM b_event;

------------------------------------------------------------------------------------------------------------

[ex2-95] Упростить меню в адмистративном разделе для контент-менеджера
bsm_api.chm
[OnBuildGlobalMenu]
[CUser] [CUser::GetUserGroupList]
[CGroup] [CGroup::GetList]

В публичной части добавляем пользователя manager, помещаем его в группу "Контент-редакторы"
В local/php_interface/include/events.php добавляем обработчик события OnBuildGlobalMenu
    public static function Ex2_95(&$aGlobalMenu, &$aModuleMenu)
    {
        echo "<pre>"; print_r($aGlobalMenu); echo "</pre>";
        echo "<pre>"; print_r($aModuleMenu); echo "</pre>";
    }
Проверяем входящие параметры
Устанавливаем флаги принадлежности текущего пользователя к группам администраторы и "Контент-редакторы"
        $isAdmin = false;
        $isManager = false;
Получаем группы которым принадлежит текущий пользователь с помощью $USER::GetUserGroupList
Получаем ид группы "Контент-редакторы" с помощью CGroup::GetList, фильтруя по "STRING_ID" => "content_editor"
Находим значения для флагов в зависимости от текущего пользователя
        while ($group = $userGroup->Fetch()) {
            if ($group["GROUP_ID"] == 1) {
                $isAdmin = true;
            }
            if ($group["GROUP_ID"] == $contentGroupId) {
                $isManager = true;
            }
        }
Для пользователя принадлежащего к группе "Контент-редакторы" и не принадлежащего к группе администраторы, формируем меню модулей
Переопределяем глобальное меню, оставляя в нем только меню контента
$aGlobalMenu = ["global_menu_content" => $aGlobalMenu["global_menu_content"]];

        if (!$isAdmin && $isManager) {
            foreach ($aModuleMenu as $key => $arItem) {
                if ($arItem["items_id"] == "menu_iblock_/news") {
                    $aModuleMenu = [$arItem];
                    foreach ($arItem["items"] as $arChildItem) {
                        if ($arChildItem["items_id"] == "menu_iblock_/news/1") {
                            $aModuleMenu[0]["items"] = [$arChildItem];
                            break;
                        }
                    }
                    break;
                }
            }
            $aGlobalMenu = ["global_menu_content" => $aGlobalMenu["global_menu_content"]];
        }
Итоговый код
    public static function Ex2_95(&$aGlobalMenu, &$aModuleMenu)
    {
        // echo "<pre>"; print_r($aGlobalMenu); echo "</pre>";
        // echo "<pre>"; print_r($aModuleMenu); echo "</pre>";
        $isAdmin = false;
        $isManager = false;
        global $USER;
        $userGroup = $USER::GetUserGroupList($USER->GetID());
        // echo "<pre>"; print_r($userGroup); echo "</pre>";
        $contentGroupId = CGroup::GetList(
            $by = "c_sort",
            $order = "asc",
            array("STRING_ID" => "content_editor")
        )->Fetch()["ID"];
        echo "<pre>"; print_r("contentGroupId: " . $contentGroupId); echo "</pre>";
        while ($group = $userGroup->Fetch()) {
            echo "<pre>"; print_r($group); echo "</pre>";
            if ($group["GROUP_ID"] == 1) {
                $isAdmin = true;
            }
            if ($group["GROUP_ID"] == $contentGroupId) {
                $isManager = true;
            }
        }
        echo "<pre>"; print_r("\$isAdmin: " . $isAdmin); echo "</pre>";
        echo "<pre>"; print_r("\$isManager: " . $isManager); echo "</pre>";
        if (!$isAdmin && $isManager) {
            foreach ($aModuleMenu as $key => $arItem) {
                echo "<pre>"; print_r($arItem); echo "</pre>";
                if ($arItem["items_id"] == "menu_iblock_/news") {
                    $aModuleMenu = [$arItem];
                    foreach ($arItem["items"] as $arChildItem) {
                        if ($arChildItem["items_id"] == "menu_iblock_/news/1") {
                            $aModuleMenu[0]["items"] = [$arChildItem];
                            break;
                        }
                    }
                    break;
                }
            }
            $aGlobalMenu = ["global_menu_content" => $aGlobalMenu["global_menu_content"]];
        }
    }
Регистрируемся в режиме "инкогнито" под пользователем manager
Проверяем что в административной части остался только "Контент" с инфоблоком "Новости"

------------------------------------------------------------------------------------------------------------

[ex2-94] Супер инструмент SEO специалиста 
bsm_api.chm
[OnBeforeProlog]
[CMain][CMain::GetCurDir]
[CMain][CMain::SetPageProperty]
[CIBlockElement] [CIBlockElement::GetList]
api_d7.chm
[Loader] [\Bitrix\Main\Loader::includeModule]

Для типа информационного блока "Товары и услуги" создаем информационный блок "Метатеги"
В созданном инфоблоке создаем два элемента в соответствии с заданием
В local/php_interface/include/events.php добавляем обработчик события OnBeforeProlog
В local/php_interface/include/constants.php добавляем константу ид инфоблока "Метатеги"
define("IBLOCK_META_ID",6);
В обработчике получаем текущий раздел с помощью $APPLICATION->GetCurDir()
В инфоблоке "Метатеги" ищем элемент по фильтру "IBLOCK_ID" => IBLOCK_META_ID, "NAME" => $curPage
Устанавливаем свойства страницы используя свойства отобранного элемента с помощью $APPLICATION->SetPageProperty

    public static function Ex2_94()
    {
        global $APPLICATION;
        $curPage = $APPLICATION->GetCurDir();
        if (\Bitrix\Main\Loader::includeModule('iblock')) {
            $arFilter = array("IBLOCK_ID" => IBLOCK_META_ID, "NAME" => $curPage);
            $arSelect = array("IBLOCK_ID", "ID", "PROPERTY_TITLE", "PROPERTY_DESCRIPTION");
            $res = CIBlockElement::GetList(array(), $arFilter, false, false, $arSelect);
            if ($ob = $res->Fetch()) {
                $APPLICATION->SetPageProperty("title", $ob["PROPERTY_TITLE_VALUE"]);
                $APPLICATION->SetPageProperty("description", $ob["PROPERTY_DESCRIPTION_VALUE"]);
            }
        }
    }
В публичной части проверяем исполнение

------------------------------------------------------------------------------------------------------------

[ex2-70] Разработать простой компонент «Каталог товаров»
bsm_api.chm
[CBitrixComponent] [CBitrixComponent::StartResultCache]
[CBitrixComponent] [CBitrixComponent::AbortResultCache]
[CBitrixComponent] [CBitrixComponent::setResultCacheKeys]
[CIBlockElement] [CIBlockElement::GetList]
[CIBlockSection] [CIBlockSection::GetList]
[CMain] [CMain::SetTitle]
api_d7.chm
[Loc] [Loc::loadMessages]
[Loc] [Loc::getMessage]

В разделе "Экзамен2" создаем раздел "Простой компонент"
В папке "local" создаем папку local/components, из материалов копируем в эту папку простой компонент
Меняем название компонента на предложенное в задании "simplecomp.exam"
В файле local/components/exam2/simplecomp.exam/.description.php меняем описание компонента

$arComponentDescription = array(
	"NAME" => GetMessage("SIMPLECOMP_EXAM2_NAME_70"),
	"CACH_PATH" => "Y",
	"PATH" => array(
		"ID" => "ex2simple",
		"NAME" => GetMessage("EXAM2")
	),
);

Открываем страницу в режиме правки, обновляем кэш, проверяем наличие своего компонента с списке
Добавляем вызов компонента на страницу 
В файле local/components/exam2/simplecomp.exam/.parameters.php добввим требуемые параметры компонента
Используем как ориентир параметры стандартного компонента bitrix/components/bitrix/news.list/.parameters.php
Возьмем оттуда "PARENT" и "CACHE_TIME" 

$arComponentParameters = array(
	"PARAMETERS" => array(
		"PRODUCTS_IBLOCK_ID" => array(
			"NAME" => GetMessage("SIMPLECOMP_EXAM2_CAT_IBLOCK_ID_70"),
			"PARENT" => "BASE",
			"TYPE" => "STRING",
		),
		"NEWS_IBLOCK_ID" => array(
			"NAME" => GetMessage("SIMPLECOMP_EXAM2_NEWS_IBLOCK_ID_70"),
			"PARENT" => "BASE",
			"TYPE" => "STRING",
		),
		"PRODUCTS_IBLOCK_ID_PROPERTY" => array(
			"NAME" => GetMessage("SIMPLECOMP_EXAM2_CAT_PROPERTY_IBLOCK_ID_70"),
			"PARENT" => "BASE",
			"TYPE" => "STRING",
		),
		"CACHE_TIME"  => array(
			"DEFAULT" => 36000000
		),

	),
);

Создаем языковые фразы для параметров в local/components/exam2/simplecomp.exam/lang/ru/.parameters.php
$MESS["SIMPLECOMP_EXAM2_CAT_IBLOCK_ID_70"] = "ID инфоблока с каталогом товаров";
$MESS["SIMPLECOMP_EXAM2_NEWS_IBLOCK_ID_70"] = "ID инфоблока с новостями";
$MESS["SIMPLECOMP_EXAM2_CAT_PROPERTY_IBLOCK_ID_70"] = "Код пользовательского свойства разделов каталога, в котором хранится привязка к
новостям";

В публичной части проверяем, что параметры отобразились в настройках компонента
В админке в инфоблоке "Продукция" создаем для разделов множественное свойство для привязки к элементам инфоблока "Новости", "UF_NEWS_LINK"
Настроим привязки разделов к новостям согласно заданию
В публичной части заполним параметры компонента
В компоненте local/components/exam2/simplecomp.exam/component.php опишем логику подготовки данных с учетом кэширования
Основные блоки
- проверка входящих параметров и установление дефолтных
- проверка наличия кэша $this->StartResultCache() и в случае его отсутствия формирование данных
- вывод заголовка $APPLICATION->SetTitle, добавленого $this->SetResultCacheKeys(array("PRODUCT_CNT"));

В local/components/exam2/simplecomp.exam.my/lang/ru/component.php добавляем языковую фразу
$MESS["COUNT_PRODUCT_CNT"] = "В каталоге представлено товаров: ";

// checking params
if (!isset($arParams["CACHE_TIME"])) {
	$arParams["CACHE_TIME"] = 36000000;
}
if (!isset($arParams["PRODUCTS_IBLOCK_ID"])) {
	$arParams["PRODUCTS_IBLOCK_ID"] = 0;
}
if (!isset($arParams["NEWS_IBLOCK_ID"])) {
	$arParams["NEWS_IBLOCK_ID"] = 0;
}

// caching
if ($this->StartResultCache()) {
	$arNewsRoot = array();
	$arNewsIds = array();
	$arSectionIds = array();
	$arFilter = array(
		'IBLOCK_ID' => $arParams["PRODUCTS_IBLOCK_ID"],
		'ACTIVE' => "Y",
	);
	$arSelect = array("NAME", "IBLOCK_ID", "ID", $arParams["PRODUCTS_IBLOCK_ID_PROPERTY"]);
	$rsSections = CIBlockSection::GetList(array(), $arFilter, true, $arSelect, false);
	while ($arSection = $rsSections->Fetch()) {
		foreach ($arSection[$arParams["PRODUCTS_IBLOCK_ID_PROPERTY"]] as $newId) {
			$arNewsRoot[$newId]["SECTIONS_NAME"][] = $arSection["NAME"];
			$arNewsRoot[$newId]["SECTIONS_IDS"][] = $arSection["ID"];
			if (!in_array($newId, $arNewsIds)) {
				$arNewsIds[] = $newId;
			}
			if (!in_array($arSection["ID"], $arSectionIds)) {
				$arSectionIds[] = $arSection["ID"];
			}
		}
	}

	$arNews = array();
	$arSelect = array("NAME", "ACTIVE_FROM", "ID");
	$arFilter = array("IBLOCK_ID" => IntVal($arParams["NEWS_IBLOCK_ID"]), "ID" => $arNewsIds, "ACTIVE" => "Y");
	$res = CIBlockElement::GetList(array(), $arFilter, false, false, $arSelect);
	while ($ob = $res->Fetch()) {
		$arNews[$ob["ID"]] = $ob;
	}

	$arProducts = array();
	$arSelect = array(
		"NAME",
		"IBLOCK_SECTION_ID",
		"ID",
		"IBLOCK_ID",
		"PROPERTY_ARTNUMBER",
		"PROPERTY_MATERIAL",
		"PROPERTY_PRICE",
	);
	$arFilter = array(
		"IBLOCK_ID" => IntVal($arParams["PRODUCTS_IBLOCK_ID"]),
		"ACTIVE" => "Y",
		"SECTION_ID" => $arSectionIds
	);
	$arResult["PRODUCT_CNT"] = 0;
	$res = CIBlockElement::GetList(array(), $arFilter, false, false, $arSelect);
	while ($ob = $res->Fetch()) {
		$arResult["PRODUCT_CNT"]++;
		$arProducts[] = $ob;
	}

	foreach ($arNewsRoot as $key => $arItem) {
		$arNewsRoot[$key]["NEWS"] = $arNews[$key];
		foreach ($arProducts as $arProduct) {
			if (in_array($arProduct["IBLOCK_SECTION_ID"], $arItem["SECTIONS_IDS"])) {
				$arNewsRoot[$key]["PRODUCTS"][] = $arProduct;
			}
		}
	}

	$arResult["NEWS"] = $arNewsRoot;
	$this->SetResultCacheKeys(array("PRODUCT_CNT"));
	$this->includeComponentTemplate();
} else {
	$this->AbortResultCache();
}
$APPLICATION->SetTitle(Loc::getMessage("COUNT_PRODUCT_CNT") . $arResult["PRODUCT_CNT"]);

Формируем вывод данных в шаблоне компонента

<? if (!empty($arResult["NEWS"])) : ?>
    <? foreach ($arResult["NEWS"] as $arNews) : ?>
        <li>
            <b><?= $arNews["NEWS"]["NAME"] ?></b>
            <?= $arNews["NEWS"]["ACTIVE_FROM"] ?>
            (<?= implode(",", $arNews["SECTIONS_NAME"]) ?>)
            <? if (!empty($arNews["PRODUCTS"])) : ?>
                <ul>
                    <? foreach ($arNews["PRODUCTS"] as $arProduct) : ?>
                        <li>
                            <?= $arProduct["NAME"] ?> -
                            <?= $arProduct["PROPERTY_PRICE_VALUE"] ?> -
                            <?= $arProduct["PROPERTY_MATERIAL_VALUE"] ?> -
                            <?= $arProduct["PROPERTY_ARTNUMBER_VALUE"] ?>
                        </li>
                    <? endforeach; ?>
                </ul>
            <? endif; ?>
        </li>
    <? endforeach; ?>
<? endif; ?>

Проверяем в публичной части корректность вывода товаров и подсчет их количества

------------------------------------------------------------------------------------------------------------

[ex2-71] Разработать простой компонент «Каталог товаров»

bsm_api.chm
[CBitrixComponent] [CBitrixComponent::StartResultCache] в примере $USER->GetGroups() 
[CBitrixComponent] [CBitrixComponent::AbortResultCache]
[CIBlockElement][CIBlockElement::GetList]
[CBitrixComponent] [CBitrixComponent::setResultCacheKeys]
[GetMessage][Главный модуль>Функции>Языковые файлы>GetMessage]

В публичной части в разделе "Экзамен2" создаем раздел "Простой компонент-71"
Создаем local/components/exam2/
Из материалов в local/components/exam2/ копируем простой компонент simplecomp.exam-materials
Меняем название компонента на предложенное в задании (simplecomp.exam.71 в примере)
Вносим правки в файл .description.php

$arComponentDescription = array(
	"NAME" => GetMessage("SIMPLECOMP_EXAM2_NAME_71"),
	"CACHE_PATH" => "Y", // отображается кнопка очистки кэша компонента
	"PATH" => array(
		"ID" => "ex2simple",
		"NAME" => GetMessage("EXAM2")
	),
);

В публичной части добавляем вызов компонента на страницу
Добавим требуемые параметры компонента в .parameters.php
Из стандартного компонента bitrix/components/bitrix/news.list/.parameters.php скопируем параметры кеширования

$arComponentParameters = array(
	"PARAMETERS" => array(
		"PRODUCTS_IBLOCK_ID" => array(
			"NAME" => GetMessage("SIMPLECOMP_EXAM2_CAT_IBLOCK_ID_71"),
			"PARENT" => "BASE",
			"TYPE" => "STRING",
		),
		"CLASSIF_IBLOCK_ID" => array(
			"NAME" => GetMessage("SIMPLECOMP_EXAM2_CLASSIF_IBLOCK_ID_71"),
			"PARENT" => "BASE",
			"TYPE" => "STRING",
		),
		"TEMPLATE" => array(
			"NAME" => GetMessage("SIMPLECOMP_EXAM2_TEMPLATE_71"),
			"PARENT" => "BASE",
			"TYPE" => "STRING",
		),
		"PROPERTY_CODE" => array(
			"NAME" => GetMessage("SIMPLECOMP_EXAM2_PROPERTY_CODE_71"),
			"PARENT" => "BASE",
			"TYPE" => "STRING",
		),
		"CACHE_TIME"  =>  ["DEFAULT"=>36000000],
		"CACHE_FILTER" => [
			"PARENT" => "CACHE_SETTINGS",
			"NAME" => GetMessage("IBLOCK_CACHE_FILTER_71"),
			"TYPE" => "CHECKBOX",
			"DEFAULT" => "N",
		],
		"CACHE_GROUPS" => [
			"PARENT" => "CACHE_SETTINGS",
			"NAME" => GetMessage("CACHE_GROUPS_71"),
			"TYPE" => "CHECKBOX",
			"DEFAULT" => "Y",
		],

	),
);

Создаем языковые файлы с соответствующими записями
Проверяем отображение параметров в настройках компонента в публичной части
Создадим инфоблок "Фирма производитель" и добавим три элемента (Бренд1,Бренд2,Бренд3)
В инфоблок "Продукция" добавляем множественное свойство Фирма FIRMA тип привязка к элементам инфоблока "Фирма производитель"
Зададим четырем элементам инфоблока "Продукция" привязки к элементам инфоблока "Форма производитель"
В публичной части передадим идентификаторы инфоблоков и код свойства

		"PRODUCTS_IBLOCK_ID" => "2",
		"CLASSIF_IBLOCK_ID" => "5",
		"PROPERTY_CODE" => "FIRMA",

Пишем логику компонента в local/components/exam2/simplecomp.exam.71/component.php

if (empty($arParams["CACHE_TIME"])) {
	$arParams["CACHE_TIME"] = 36000000;
}
if (empty($arParams["PRODUCTS_IBLOCK_ID"])) {
	$arParams["PRODUCTS_IBLOCK_ID"] = 0;
}
if (empty($arParams["CLASSIF_IBLOCK_ID"])) {
	$arParams["CLASSIF_IBLOCK_ID"] = 0;
}
$arParams["PROPERTY_CODE"] = trim($arParams["PROPERTY_CODE"]);
global $USER;

if ($this->StartResultCache(false, array($USER->GetGroups()))) {
	$arClassif = array();
	$arClassifId = array();
	$arResult["COUNT"] = 0;

	$arSelect = array(
		"ID",
		"IBLOCK_ID",
		"NAME",
	);
	$arFilter = array(
		"IBLOCK_ID" => IntVal($arParams["CLASSIF_IBLOCK_ID"]),
		"CHECK_PERMISSIONS" => $arParams["CACHE_GROUPS"],
		"ACTIVE" => "Y"
	);
	$res = CIBlockElement::GetList(array(), $arFilter, false, false, $arSelect);
	while ($ob = $res->GetNext()) {
		$arClassif[$ob["ID"]] = $ob;
		$arClassifId[] = $ob["ID"];
	}
	$arResult["COUNT"] = count($arClassif);
	$arSelect = array(
		"ID",
		"IBLOCK_ID",
		"IBLOCK_SECTION_ID",
		"NAME",
		"DETAIL_PAGE_URL"
	);
	$arFilter = array(
		"IBLOCK_ID" => IntVal($arParams["PRODUCTS_IBLOCK_ID"]),
		"CHECK_PERMISSIONS" => $arParams["CACHE_GROUPS"],
		"PROPERTY_" . $arParams["PROPERTY_CODE"] => $arClassifId,
		"ACTIVE" => "Y"
	);

	$res = CIBlockElement::GetList(array(), $arFilter, false, false, $arSelect);
	while ($ob = $res->GetNextElement()) {
		$arFields = $ob->GetFields();
		$arFields["PROPERTY"] = $ob->GetProperties();
		foreach ($arFields["PROPERTY"]["FIRMA"]["VALUE"] as $value) {
			$arClassif[$value]["ELEMENTS"][] = $arFields;
		}
		// $arResult["ELEMENTS"][$arFields["ID"]] = $ob;
	}
	$arResult["CLASSIF"] = $arClassif;
	// echo "<pre>";
	// print_r($arResult["CLASSIF"]);
	// echo "</pre>";
	$this->SetResultCacheKeys(array("COUNT"));
	$this->includeComponentTemplate();
} else {
	$this->AbortResultCache();
}
$APPLICATION->SetTitle(GetMessage("COUNT_71") . $arResult["COUNT"]);

Формируем шаблон компонента

<p><b><?= GetMessage("SIMPLECOMP_EXAM2_CAT_TITLE_71") ?></b></p>
<? if (!empty($arResult["CLASSIF"])) : ?>
    <ul>
        <? foreach ($arResult["CLASSIF"] as $arClassif) : ?>
            <li>
                <b><?= $arClassif["NAME"] ?></b>
                <? if (!empty($arClassif["ELEMENTS"])) : ?>
                    <ul>
                        <? foreach ($arClassif["ELEMENTS"] as $arEl) : ?>
                            <?//R52::debug($arEl)?>
                            <li>
                                <?= $arEl["NAME"] ?> -
                                <?= $arEl["PROPERTY"]["PRICE"]["VALUE"] ?> -
                                <?= $arEl["PROPERTY"]["MATERIAL"]["VALUE"] ?> -
                                <?= $arEl["PROPERTY"]["ARTNUMBER"]["VALUE"] ?> -
                                <a href="<?= $arEl["DETAIL_PAGE_URL"] ?>">ссылка на детальный просмотр</a>
                            </li>
                        <? endforeach; ?>
                    </ul>
                <? endif ?>
            </li>
        <? endforeach; ?>
    </ul>
<? endif; ?>

Проверяем вывод элементов и заголовка

------------------------------------------------------------------------------------------------------------

[ex2-97] Разработать простой компонент «Новости по интересам» 
bsm_api.chm
[CUser] [CUser::GetList] 
[CIBlockElement] [CIBlockElement::GetList]
[SetResultCacheKeys] (Главный модуль>Классы>CBitrixComponent>setResultCacheKeys)
[CBitrixComponent] [CBitrixComponent::AbortResultCache]
[CMain] [CMain::SetTitle]
[GetMessage][Главный модуль>Функции>Языковые файлы>GetMessage]

В публичной части в разделе "Экзамен2" создаем раздел "Простой компонент-97"
Создаем local/components/exam2/
Из материалов в local/components/exam2/ копируем простой компонент simplecomp.exam-materials
Меняем название компонента на предложенное в задании (simplecomp.exam.97 в примере)
Вносим правки в файл .description.php

$arComponentDescription = array(
	"NAME" => GetMessage("SIMPLECOMP_EXAM2_NAME_97"),
	"CACHE_PATH" => "Y",
	"PATH" => array(
		"ID" => "ex2simple",
		"NAME" => GetMessage("EXAM2")
	),
);

В публичной части добавляем вызов компонента на страницу
Добавим требуемые параметры компонента в .parameters.php
Из стандартного компонента bitrix/components/bitrix/news.list/.parameters.php скопируем параметры кеширования

$arComponentParameters = array(
	"PARAMETERS" => array(
		"NEWS_IBLOCK_ID" => array(
			"NAME" => GetMessage("SIMPLECOMP_EXAM2_NEWS_IBLOCK_ID"),
			"PARENT" => "BASE",
			"TYPE" => "STRING",
		),
		"EXAM2_PROPERTY" => array(
			"NAME" => GetMessage("SIMPLECOMP_EXAM2_PROPERTY"),
			"PARENT" => "BASE",
			"TYPE" => "STRING",
		),
		"PROPERTY_UF" => array(
			"NAME" => GetMessage("SIMPLECOMP_EXAM2_PROPERTY_UF"),
			"PARENT" => "BASE",
			"TYPE" => "STRING",
		),
		"CACHE_TIME"  =>  ["DEFAULT"=>36000000],
		"CACHE_FILTER" => [
			"PARENT" => "CACHE_SETTINGS",
			"NAME" => GetMessage("IBLOCK_CACHE_FILTER"),
			"TYPE" => "CHECKBOX",
			"DEFAULT" => "N",
		],
		"CACHE_GROUPS" => [
			"PARENT" => "CACHE_SETTINGS",
			"NAME" => GetMessage("CP_BNL_CACHE_GROUPS"),
			"TYPE" => "CHECKBOX",
			"DEFAULT" => "Y",
		],

	),
);

Создаем языковые файлы с соответствующими записями
Проверяем отображение параметров в настройках компонента в публичной части
Добавляем пользовательское свойство для пользователей UF_AUTHOR_TYPE в соответствии с заданием
Создаем трех тестовых пользователей, логины: test1, test2, test3 и устанавливаем свойство "Тип автора" в соответствии с заданием
В информационном блоке Новости добавляем множественное свойство – Автор, тип - привязка к пользователю
Добавить три тестовые новости с произвольным контентом и задаем им значение свойства Автор в соответствии с заданием

В публичной части передадим идентификаторы инфоблоков и код свойства

		"NEWS_IBLOCK_ID" => "1",
		"EXAM2_PROPERTY" => "AUTHOR",
		"PROPERTY_UF" => "UF_AUTHOR_TYPE",

Пишем логику компонента в local/components/exam2/simplecomp.exam.97/component.php

if (empty($arParams["CACHE_TIME"])) {
	$arParams["CACHE_TIME"] = 36000000;
}
if (empty($arParams["NEWS_IBLOCK_ID"])) {
	$arParams["NEWS_IBLOCK_ID"] = 0;
}
$arParams["EXAM2_PROPERTY"] = trim($arParams["EXAM2_PROPERTY"]);
$arParams["PROPERTY_UF"] = trim($arParams["PROPERTY_UF"]);

global $USER;
if ($USER->IsAuthorized()) {
	$curUserId = $USER->GetID();
	$curUserType = CUser::GetList(
		"id",
		"asc",
		array("ID" => $curUserId),
		array("SELECT" => array($arParams["PROPERTY_UF"]))
	)->Fetch()[$arParams["PROPERTY_UF"]];
}

if ($this->StartResultCache(false, array($curUserType, $curUserId))) {
	// user
	$userList = array();
	$userListId = array();

	$arOrderUser = array("id");
	$sortOrder = "asc";
	$arFilterUser = array(
		$arParams["PROPERTY_UF"] => $curUserType,
		"!ID" => $curUserId
	);
	$arSelectUser = array("SELECT" => array("LOGIN", "ID"));

	$rsUsers = CUser::GetList($arOrderUser, $sortOrder, $arFilterUser, $arFilterUser); // выбираем пользователей
	while ($arUser = $rsUsers->GetNext()) {
		$userList[$arUser["ID"]] = array("LOGIN" => $arUser["LOGIN"]);
		$userListId[] = $arUser["ID"];
	}

	$arNewsList = array();

	$arSortElems = array(
		"NAME" => "ASC"
	);
	$arFilterElems = array(
		"IBLOCK_ID" => $arParams["NEWS_IBLOCK_ID"],
	);
	$arSelectElems = array(
		"ID",
		"IBLOCK_ID",
		"NAME",
		"ACTIVE_FROM",
		"PROPERTY_" . $arParams["EXAM2_PROPERTY"]
	);

	$rsElements = CIBlockElement::GetList($arSortElems, $arFilterElems, false, false, $arSelectElems);
	while ($arElement = $rsElements->GetNext()) {
		$arNewsAuthor[$arElement["ID"]][] = $arElement["PROPERTY_" . $arParams["EXAM2_PROPERTY"] . "_VALUE"];
		if (empty($arNewsList[$arElement["ID"]])) {
			$arNewsList[$arElement["ID"]] = $arElement;
		}
		$arNewsList[$arElement["ID"]]["AUTHORS"][] = $arElement["PROPERTY_" . $arParams["EXAM2_PROPERTY"] . "_VALUE"];
	}
	$newsIds = array();
	foreach ($arNewsList as $key => $arIem) {
		$canAdd = true;
		foreach ($arIem["AUTHORS"] as $authorId) {
			if ($authorId == $curUserId) {
				$canAdd = false;
			}
		}
		foreach ($arIem["AUTHORS"] as $authorId) {
			if ($canAdd && in_array($authorId, $userListId)) {
				$userList[$authorId]["NEWS"][] = $arIem;
				if (!in_array($arIem["ID"], $newsIds)) {
					$newsIds[] = $arIem["ID"];
				}
			}
		}
	}
	$arResult["AUTHORS"] = $userList;
	$arResult["COUNT"] = count($newsIds);

	$this->SetResultCacheKeys(array("COUNT"));
	$this->includeComponentTemplate();
} else {
	$this->AbortResultCache();
}
$APPLICATION->SetTitle(GetMessage("COUNT_97") . $arResult["COUNT"]);

Формируем шаблон компонента

<? if (!empty($arResult["AUTHORS"])) : ?>
    <? foreach ($arResult["AUTHORS"] as $key => $arAuthor) : ?>
        <ul>
            <li>
                <b> [<?= $key ?>] - <?= $arAuthor["LOGIN"] ?></b>
                <ul>
                    <? foreach ($arAuthor["NEWS"] as $arNews) : ?>
                        <li>
                            - <?= $arNews["NAME"] ?>
                        </li>
                    <? endforeach; ?>
                </ul>
            </li>
        </ul>
    <? endforeach; ?>
<? endif; ?>

Проверяем вывод элементов и заголовка

------------------------------------------------------------------------------------------------------------

[ex2-81] Внести доработки в созданный простой компонент «Каталог товаров»

Дорабатывается компонент из задания [ex2-70] Разработать простой компонент «Каталог товаров» 
В компонент local/components/exam2/simplecomp.exam/component.php добавим сортировку в соответствие с заданием
для элементов инфоблока "Продукция" 

	$arOrder = array(
		"NAME" => "ASC",
		"SORT" => "ASC"
	);

В публичной части после очистки кэша проверим результаты
В параметры компонента local/components/exam2/simplecomp.exam/.parameters.php добавляем строковый из задания

		"LINK_TEMPLATE_DETAIL" => array(
			"NAME" => GetMessage("SIMPLECOMP_EXAM2_LINK_TEMPLATE_DETAIL"),
			"PARENT" => "BASE",
			"TYPE" => "STRING",
			"DEFAULT" => "catalog_exam/#SECTION_ID#/#ELEMENT_CODE#"
		),

В компонент local/components/exam2/simplecomp.exam/component.php добавим форматирование и добавление ссылки на детальный просмотр
для элементов инфоблока "Продукция" 

		$ob["DETAIL_PAGE_URL"] = str_replace(
			array(
				"#SECTION_ID#",
				"#ELEMENT_CODE#"
			),
			array(
				$ob["IBLOCK_SECTION_ID"],
				$ob["CODE"],
			),
			$arParams["LINK_TEMPLATE_DETAIL"]
		);

В шаблон local/components/exam2/simplecomp.exam/templates/.default/template.php добавим условие вывода элементов
        if (empty($arNews["SECTIONS"])) {
            continue;
        }
что бы исключить ошибки связанные с более поздними заданиями, и добавим вывод ссылки на детальный просмотр

(<?= $arProduct["DETAIL_PAGE_URL"] . ".php" ?>)

Проверим результат в публичной части

------------------------------------------------------------------------------------------------------------

[ex2-49] Добавить дополнительную фильтрацию элементов в созданный простой
компонент «Каталог товаров»

Дорабатывается компонент из задания [ex2-70] Разработать простой компонент «Каталог товаров» 
В компонент local/components/exam2/simplecomp.exam/component.php добавим фильтрацию в соответствие с заданием

Перед кешированием проверка на наличие get параметра "F" и выставление соответствующего флага
$isFilter = false;
if (isset($_REQUEST["F"])) {
	$isFilter = true;
}

Добавление параметра кеширования
if ($this->StartResultCache(false, array($isFilter)))

Добвление условия фильтрации к имеющемуся фильтру и остановка кеширования
	if ($isFilter) {
		$arFilterElements[] = array(
			array("<=PROPERTY_PRICE" => 1700, "PROPERTY_MATERIAL" => "Дерево, ткань"),
			array("<PROPERTY_PRICE" => 1500, "PROPERTY_MATERIAL" => "Металл, пластик"),
			"LOGIC" => "OR"
		);
		$this->AbortResultCache();
	}

Добавить в шаблон local/components/exam2/simplecomp.exam/templates/.default/template.php
ссылку с get параметром

$url = $APPLICATION->GetCurPage()."?F=Y";
echo GetMessage("FILTER_TITLE").'<a href="'. $url .'">' . $url.'</a><br>';

Проверить в публичной части работу фильтра и кеша

------------------------------------------------------------------------------------------------------------

[ex2-58] Добавить управление элементами – «Эрмитаж» в созданный простой компонент
«Каталог товаров»

bsm_api.chm
[CIBlock] [CIBlock::GetPanelButtons]

Дорабатывается компонент из задания [ex2-70] Разработать простой компонент «Каталог товаров» 
В компоненте local/components/exam2/simplecomp.exam/component.php формируем управляющие ссылки для каждого элемента

		$arButtons = CIBlock::GetPanelButtons(
			$arParams["PRODUCTS_IBLOCK_ID"],
			$ob["ID"],
			0,
			array("SECTION_BUTTONS" => false, "SESSID" => false)
		);
		$ob["EDIT_LINK"] = $arButtons["edit"]["edit_element"]["ACTION_URL"];
		$ob["DELETE_LINK"] = $arButtons["edit"]["delete_element"]["ACTION_URL"];
		$arResult["ADD_LINK"] = $arButtons["edit"]["add_element"]["ACTION_URL"];
		$arResult["IBLOCK_ID"] = $arParams["PRODUCTS_IBLOCK_ID"];

В шаблоне local/components/exam2/simplecomp.exam/templates/.default/template.php добавим функционал эрмитажа
в качестве примера возьмем bitrix/components/bitrix/news.list/templates/.default/template.php

<?
$this->AddEditAction($arNews["ID"] . "_" . $arProduct['ID'], $arProduct['EDIT_LINK'], CIBlock::GetArrayByID($arProduct["IBLOCK_ID"], "ELEMENT_EDIT"));
$this->AddDeleteAction($arNews["ID"] . "_" . $arProduct['ID'], $arProduct['DELETE_LINK'], CIBlock::GetArrayByID($arProduct["IBLOCK_ID"], "ELEMENT_DELETE"), array("CONFIRM" => GetMessage('CT_BNL_ELEMENT_DELETE_CONFIRM')));
?>
<li id="<?= $this->GetEditAreaId($arNews["ID"] . "_" . $arProduct['ID']); ?>">

Для добавления элемента, добавим ссылки в родительский элемент
<?
$this->AddEditAction($arNews["ID"], $arResult['ADD_LINK'], CIBlock::GetArrayByID($arResult["IBLOCK_ID"], "ELEMENT_ADD"));
?>
<ul id="<?= $this->GetEditAreaId($arNews["ID"]); ?>">

Проверим в публичной части добавление и удаление и изменение элемента

------------------------------------------------------------------------------------------------------------

[ex2-100] Добавить пункт «ИБ в админке» в выпадающем меню компонента.

bsm_api.chm
[CIBlock] [CIBlock::GetPanelButtons]
[AddIncludeAreaIcons] [CBitrixComponent::AddIncludeAreaIcons]

Дорабатывается компонент из задания [ex2-70] Разработать простой компонент «Каталог товаров» 
В компоненте local/components/exam2/simplecomp.exam/component.php проверяем авторизацию пользователя, получаем массив кнопок,
добавляем новую кнопку в соответствие с заданием, для режима редактирования компонента в публичной части


global $USER;
if ($USER->IsAuthorized()) {
	$arButtons = CIBlock::GetPanelButtons($arParams["PRODUCTS_IBLOCK_ID"]);
	$this->AddIncludeAreaIcons(
		array(
			array(
				"ID" => "LinkId",
				"TITLE" => GetMessage("IB_IN_ADMIN"),
				"URL" => $arButtons["submenu"]["element_list"]["ACTION_URL"],
				"IN_PARAMS_MENU" => true
			)
		)
	);
}

Проверяем результат в публичной части

------------------------------------------------------------------------------------------------------------

[ex2-82] Добавить отображение данных в шаблон сайта

bsm_api.chm
[CBitrixComponent] [CBitrixComponent::setResultCacheKeys]
[GetMessage][Главный модуль>Функции>Языковые файлы>GetMessage]
[AddViewContent] [CMain::AddViewContent]
[ShowViewContent][CMain::ShowViewContent]

php_enhanced_ru.chm
[str_replace]
[min]
[max]

Дорабатывается компонент из задания [ex2-70] Разработать простой компонент «Каталог товаров» 
Добавим файл local/components/exam2/simplecomp.exam/templates/.default/result_modifier.php
Получим массив с ценами товаров, посчитаем min, max подготовим передачу данных в component_epilog

if (!defined("B_PROLOG_INCLUDED") || B_PROLOG_INCLUDED !== true) die();
$arPrice = array();
foreach ($arResult["NEWS"] as $arNews) {
    if (!empty($arNews["PRODUCTS"])) {
        foreach ($arNews["PRODUCTS"] as $arProduct) {
            $arPrice[] = $arProduct["PROPERTY_PRICE_VALUE"];
        }
    }
}
$arResult["MIN_PRICE"] = min($arPrice);
$arResult["MAX_PRICE"] = max($arPrice);
$this->__component->SetResultCacheKeys(array("MIN_PRICE", "MAX_PRICE"));

Добавим local/components/exam2/simplecomp.exam/templates/.default/component_epilog.php
Подготовим html для вывода отложенной функцией в шаблон (header), если будут получены данные

if (!defined("B_PROLOG_INCLUDED") || B_PROLOG_INCLUDED !== true) die();
if (isset($arResult["MIN_PRICE"]) && isset($arResult["MAX_PRICE"])) {
    $infoTemplates = '<div style="color:red; margin: 34px 15px 35px 15px">#TEXT#</div>';
    $sText = GetMessage("MIN_PRICE") . $arResult["MIN_PRICE"] . "<br>" . GetMessage("MAX_PRICE") . $arResult["MAX_PRICE"];
    $finalText = str_replace("#TEXT#", $sText, $infoTemplates);
    $APPLICATION->AddViewContent("prices", $finalText);
}

В шаблон local/templates/furniture_dark-blue/header.php (левый сайдбар, под поиском) выведем html из эпилога

<?
$APPLICATION->IncludeComponent("bitrix:search.form", "flat", Array(
	"PAGE" => "#SITE_DIR#search/",
),
	false
);
?>
					</div>
				</div>
<?
$APPLICATION->ShowViewContent("prices");
?>

Проверим результат в публичной части

------------------------------------------------------------------------------------------------------------

[ex2-60] Добавить постраничную навигацию в созданный простой компонент

CDBResult::GetNavParams() // нет в документации

bsm_api.chm
[CDBResult][CDBResult::GetPageNavString]
[CBitrixComponent] [CBitrixComponent::StartResultCache] 
[CIBlockElement][CIBlockElement::GetList]

Дорабатывается компонент из задания [ex2-70] Разработать простой компонент «Каталог товаров» 
Добавим в local/components/exam2/simplecomp.exam/.parameters.php параметр "Количество элементов на странице"

"ELEMENT_PER_PAGE" => array(
	"NAME" => GetMessage("SIMPLECOMP_EXAM2_ELEMENT_PER_PAGE"),
	"PARENT" => "BASE",
	"TYPE" => "STRING",
	"DEFAULT" => 2
),

В публичной части пересохраним настройки компонента для добавления нового параметра

В компоненте local/components/exam2/simplecomp.exam/component.php добавляем получение дефолтных параметров пагинации
$arNavigation = CDBResult::GetNavParams();

Передаем массив параметров пагинации как аргумент для кеширования
if ($this->StartResultCache(false, array($isFilter, $arNavigation))) 

Для элементов новости, добавляем параметры пагинации, и получаем верстку в переменную $arResult["NAV_STRING"]

	$arNavStartParams = array(
		"nPageSize" => $arParams["ELEMENT_PER_PAGE"],
		"bShowAll" => true
	);
	$res = CIBlockElement::GetList(array(), $arFilter, false, $arNavStartParams, $arSelect);
	$arResult["NAV_STRING"] = $res->GetPageNavString(GetMessage("PAGE_TITLE"));

В шаблоне компонента local/components/exam2/simplecomp.exam/templates/.default/template.php
выводим постраничную навигацию

    <? endforeach; ?>
    <p>
        <b><?= GetMessage("NAV") ?></b>
    </p>
    <?= $arResult["NAV_STRING"] ?>
<? endif; ?>

Проверям работу пагинации в публичной, части, в компонент добавляем проверки в вывод элементов Продукции 

if (isset($arNews[$newsId])) {
	$arNews[$newsId]["PRODUCTS"][] = $ob;
}

if (isset($arNews[$newsId])) {
	$arNews[$newsId]["SECTIONS"][] = $arSection["NAME"];
}

Выведем кнопку "Показать все элементы" изменив параметры пагинации в компоненте с false на true
"bShowAll" => true

Проверяем в публичной части работу кеширования

------------------------------------------------------------------------------------------------------------

[ex2-107] Автоматический сброс кеша в компоненте при изменении элемента информационного блока «Услуги».

bsm_api.chm
[CBitrixComponent] [CBitrixComponent::StartResultCache] 

Дорабатывается компонент из задания [ex2-70] Разработать простой компонент «Каталог товаров» 

Добавляем в bitrix/php_interface/dbconn.php константу
define("BX_COMP_MANAGED_CACHE", true);

Определяем в local/components/exam2/simplecomp.exam/component.php глобальный обьект
global $CACHE_MANAGER;
передаем параметр место хранения кеша "/servicesIblock" в кеширование 
if ($this->StartResultCache(false, array($isFilter, $arNavigation, "/servicesIblock")))

Добавляем в кеширование регистрацию инфоблока изменений (в нашем случае "Услуги") 
$CACHE_MANAGER->RegisterTag("iblock_id_3");

Добавляем в шаблон local/components/exam2/simplecomp.exam/templates/.default/template.php
вывод метки времени
echo GetMessage("TIME") . time();

В публичной части проверяем работу, изменяя элемент инфоблока "Услуги"

------------------------------------------------------------------------------------------------------------

[ex2-88] Оценить скорость работы сайта – страницы и созданный простой компонент «Каталог товаров»

Создать страницу в соответствие с заданием ex2/time_control-88/index.php для записи результатов
В панели производительности запустить тестирование на 1мин, в публичной части кликать по главному меню
С вкладки "Разработка" взять данные о самой нагруженной страницы и записать в результат
На странице "Новости" загрузить детальную страницу в режиме "Отладка" с "Детальная статистика кеша"
Записать данные кеша компонента news.detail в результат
В компоненте bitrix/components/bitrix/news.detail/component.php установить 
$resultCacheKeys = array("ID");
На странице "Новости" вновь загрузить детальную страницу в режиме "Отладка" с "Детальная статистика кеша"
Записать новые данные кеша компонента news.detail, посчитать разницу с предидущим и записать в результат

Итоговый результат

<div>Самая ресурсоемкая страница: /products/index.php Доля нагрузки: 12.93%</div>
<div>Работа компонента по умолчанию: кеш 15 КБ</div>
<div>Работа компонента только нужные параметры: кеш 4 КБ</div>
<div>Разница: 15 КБ - 4 КБ = 11 КБ</div>

В компоненте bitrix/components/bitrix/news.detail/component.php удалить 
$resultCacheKeys = array("ID");

------------------------------------------------------------------------------------------------------------

[ex2-10] Оценить скорость работы сайта – найти самую долгую страницу и самый долгий компонент

Создать страницу в соответствие с заданием ex2/time_control-10/index.php для записи результатов
Выключить автокеширование компонентов 
В панели производительности запустить тестирование на 1мин, в публичной части кликать по главному меню
С вкладки "Разработка" взять данные о самой нагруженной страницы и записать в результат
На самой загруженной странице "Продукция" загрузить страницу в режиме "Отладка" с "Детальная статистика кеша"
Найти по времени самый долгий компонент и записать в результат

Итоговый результат

<div>Самая ресурсоемкая страница: /products/index.php Доля нагрузки: 38.81% Среднее время генерации страницы: 0.1873</div>
<div>Самый загруженный компонент на проблемной странице: bitrix:catalog: 0.0359 с</div>

Включить автокеширование компонентов

------------------------------------------------------------------------------------------------------------

[ex2-11] Оценить скорость работы сайта – найти самую долгую страницу и количество запросов 

Создать страницу в соответствие с заданием ex2/time_control-10/index.php для записи результатов
Выключить автокеширование компонентов 
В панели производительности запустить тестирование на 1мин, в публичной части кликать по главному меню
С вкладки "Разработка" взять данные о самой нагруженной страницы и записать в результат
На самой загруженной странице "Продукция" загрузить страницу в режиме "Отладка" с "Детальная статистика кеша"
Найти по максимальному количеству запросов самый проблемный компонент и записать в результат

Итоговый результат

<div>Самая ресурсоемкая страница: /products/index.php Доля нагрузки: 41.26%	Среднее время генерации страницы: 0.1933</div>
<div>Проблемный компонент bitrix:catalog.section: Запросов: 8</div>

Включить автокеширование компонентов

------------------------------------------------------------------------------------------------------------

[ex2-25] Создание комплексного компонента «Моя фотогалерея»

1 Формирование ссылки в sections_top.php
Добавить раздел /ex2/complexcomponent
Скопировать коплексный компонент из материалов в local/components/exam2 переименовать в complexcomp
В local/components/exam2/complexcomp/.description.php заменить ID
		"ID" => "ex2simple",
что бы все компоненты лежали в одном разделе
В публичной части вывести компонент на страницу ex2/complexcomponent/index.php
В local/components/exam2/complexcomp/.parameters.php добавим два параметра и страницу
	"PARAMETERS" => array(
		"VARIABLE_ALIASES" => Array(
			"PARAM1" => Array("NAME" => GetMessage("PARAM1")),
			"PARAM2" => Array("NAME" => GetMessage("PARAM2")),
		"SEF_MODE" => Array(
			"exampage" => array(
					"NAME" => GetMessage("EXAM_PAGE"),
					"DEFAULT" => "exam/new/#PARAM1#",
					"VARIABLES" => array("PARAM1")
			),	
В local/components/exam2/complexcomp/component.php добавим 

$arDefaultUrlTemplates404 = array(
  	"exampage" => "exam/new/#PARAM1#",

$arComponentVariables = array(
	"PARAM1",
	"PARAM2",

elseif(isset($arVariables["PARAM1"]) && !empty($arVariables["PARAM1"]))
	$componentPage = "exampage";

В local/components/exam2/complexcomp/templates/.default/sections_top.php добавим

$param1 = 123;
$param2 = 456;
$url = "";
if ($arParams["SEF_MODE"] == "Y") {
	$url = $arParams["SEF_FOLDER"] . str_replace("#PARAM1#", $param1, $arParams["SEF_URL_TEMPLATES"]["exampage"]) . "?PARAM2=$param2";
} else {
	$url = $APPLICATION->GetCurPage() . "?PARAM1=$param1&PARAM2=$param2";
}
<?= GetMessage("EXAM_TEXT_LINK_CP_PHOTO") ?> <a href="<?= $url ?>"><?= $url ?></a>

В local/components/exam2/complexcomp/templates/.default/exampage.php добавим

echo "PARAM1 = " . $arResult["VARIABLES"]["PARAM1"] . "<br>";
echo "PARAM2 = " . $arResult["VARIABLES"]["PARAM2"] . "<br>";

Проверим переход по ссылке с sections_top.php на exampage.php и получение нужных параметров как в режиме чпу, так и без

2 Формирование ссылки в detail.php
Добавить раздел /ex2/complexcomponent (в примере complexcomponent2)
Скопировать коплексный компонент из материалов в local/components/exam2 переименовать в complexcomp (в примере complexcomp3)
В local/components/exam2/complexcomp/.description.php заменить ID
		"ID" => "ex2simple",
что бы все компоненты лежали в одном разделе
В публичной части вывести компонент на страницу ex2/complexcomponent2/index.php
В local/components/exam2/complexcomp3/.parameters.php добавим

	"PARAMETERS" => array(
		"VARIABLE_ALIASES" => Array(
			"PARAM1" => Array("NAME" => GetMessage("PARAM1")),
			"PARAM2" => Array("NAME" => GetMessage("PARAM2")),
		"SEF_MODE" => Array(
			"exampage" => array(
					"NAME" => GetMessage("EXAM_PAGE"),
					"DEFAULT" => "exam/new/#SECTION_ID#/#ELEMENT_ID#/#PARAM1#",
					"VARIABLES" => array("PARAM1","ELEMENT_ID", "SECTION_ID")
			),	

local/components/exam2/complexcomp3/component.php добавим (заменим)

$arDefaultUrlTemplates404 = array(
	"exampage" => "exam/new/#SECTION_ID#/#ELEMENT_ID#/#PARAM1#",

$arComponentVariables = array(
	"PARAM1",
	"PARAM2",

if (isset($arVariables["PARAM1"]) && !empty($arVariables["PARAM1"]))
	$componentPage = "exampage";	

В local/components/exam2/complexcomp3/templates/.default/detail.php добавим

$param1 = "edit";
$param2 = 789;
$SECTION_ID = $arResult['VARIABLES']['SECTION_ID'];
$ELEMENT_ID = $arResult['VARIABLES']['ELEMENT_ID'];
$url = "";
if ($arParams["SEF_MODE"] == "Y") {
	$url = $arParams["SEF_FOLDER"] . str_replace(array("#PARAM1#","#SECTION_ID#","#ELEMENT_ID#"), array($param1,$SECTION_ID,$ELEMENT_ID), $arParams["SEF_URL_TEMPLATES"]["exampage"]) . "?PARAM2=$param2";
} else {
	$url = $APPLICATION->GetCurPage() . "?PARAM1=$param1&PARAM2=$param2&SECTION_ID=$SECTION_ID&ELEMENT_ID=$ELEMENT_ID";
}

<?= GetMessage("EXAM_TEXT_LINK_CP_PHOTO") ?> <a href="<?= $url ?>"><?= $url ?></a>

В local/components/exam2/complexcomp3/templates/.default/exampage.php добавим

echo "PARAM1 = " . $arResult["VARIABLES"]["PARAM1"] . "<br>";
echo "PARAM2 = " . $arResult["VARIABLES"]["PARAM2"] . "<br>";
echo "SECTION_ID = " . $arResult["VARIABLES"]["SECTION_ID"] . "<br>";
echo "ELEMENT_ID = " . $arResult["VARIABLES"]["ELEMENT_ID"] . "<br>";

Проверим переход по ссылке с detail.php на exampage.php и получение нужных параметров как в режиме чпу, так и без

------------------------------------------------------------------------------------------------------------

[ex2-54] Подсчет количества зарегистрированных пользователей

Добавим local/php_interface/include/agents.php
Подключим в local/php_interface/init.php
if(file_exists($_SERVER["DOCUMENT_ROOT"]."/local/php_interface/include/agents.php")){
    require_once($_SERVER["DOCUMENT_ROOT"]."/local/php_interface/include/agents.php");
}

Добавим функцию в local/php_interface/include/agents.php

function CheckUserCount()
{
    $date = new DateTime();
    $date = \Bitrix\Main\Type\DateTime::createFromTimestamp($date->getTimestamp());
    $lastDate = COption::GetOptionString("main", "Last_date_agent_checkUserCount");

    // $filter = array(
    //     "DATE_REGISTER_1" => $yesterday_date_from,
    //     "DATE_REGISTER_2" => $tomorrow_date_to
    // );

    if ($lastDate) {
        $arFilter = array("DATE_REGISTER_1" => $lastDate);
    } else {
        $arFilter = array();
    }
    $arUsers = array();

    $by = "DATE_REGISTER";
    $order =  "ASC";
    $rsUser = CUser::GetList($by, $order, $arFilter);
    while ($user = $rsUser->Fetch()) {
        $arUsers[] = $user;
    }

    if (!$lastDate) {
        $lastDate = $arUsers[0]["DATE_REGISTER"];
    }
    $differens = intval(abs(strtotime($lastDate) - strtotime($date->toString())));
    $days = round($differens / (3600 * 24));
    $countUsers = count($arUsers);

    $by = "ID";
    $order =  "ASC";
    $rsAdmin = CUser::GetList($by, $order, array("GROUPS_ID" => 1));
    while ($admin = $rsAdmin->Fetch()) {
        CEvent::Send(
            "COUNT_REGISTRED_USERS",
            "s1",
            array(
                "EMAIL_TO" => $admin["EMAIL"],
                "COUNT_USERS" => $countUsers,
                "COUNT_DAYS" => $days
            ),
            "Y",
            "71"
        );
    }
    COption::SetOptionString("main", "Last_date_agent_checkUserCount", $date->toString());

    return "CheckUserCount();";
}

В административной части добавим и настроим агента

Дата последнего запуска:	07.05.2024 13:31:18
Дата и время следующего запуска:	
08.05.2024 01:00:00
Активен:	
Модуль:	
Функция агента:	
CheckUserCount();
ID пользователя:	
  
Сортировка:	
0
Периодичность выполнения:	через заданный интервал
точно в указанное время
Интервал (сек.):	
86400

Проверим отработку Функции CheckUserCount(); через командную строку php и таблицу b_event

------------------------------------------------------------------------------------------------------------

[ex2-102] Добавить англоязычную версию сайта (один инфоблок).

В публичной части добавить раздел ex2/site2
Скопировать из материалов щаблон сайта в local/templates/ex2_multilang_template_materials
В админке добавить второй сайт (id: s2, название: Второй сайт,  папка: /ex2/site2/, язык: en, шаблон: ex2_multilang_template_materials)
Привязать инфоблок "Новости" к s2, добавить свойства по заданию
В настройках формы редактирования элементов, располагаем английские поля под их русскими аналогами
Заполнить у элементов инфоблока "Новости" данные поля по заданию
Добавить вызов компонента news.list на ex2/site2/index.php, формат даты: "Формат сайта"
Копируем шаблон компонента в local/templates/ex2_multilang_template_materials/components/bitrix/news.list/template1
Редактируем шаблон в соответствии с заданием (английские название и анонс)
Добавим папку ex2/site2/include и копируем туда из задания ex2/site2/include/motto.php
В local/templates/ex2_multilang_template_materials/header.php выводим контент из этого файла

<td id="banner-slogan">
	<? $APPLICATION->IncludeFile(
		SITE_DIR . 'include/motto.php',
		array(),
		array(
			'MODE' => 'html',
			'NAME' => 'motto',
		)
	); ?>
</td>

В test.php получить вызов компонента переключателя языка, выбрав шаблон "dropdown"
<?$APPLICATION->IncludeComponent(
	"bitrix:main.site.selector", 
	"dropdown", 
	array(
		"CACHE_TIME" => "3600",
		"CACHE_TYPE" => "A",
		"SITE_LIST" => array(
			0 => "*all*",
		),
		"COMPONENT_TEMPLATE" => "dropdown"
	),
	false
);?>

Дефолтный шаблон в публичной части скопировать в bitrix/templates/.default
Затем скопировать bitrix/templates/.default в local/templates/.default
В шаблоне local/templates/.default/components/bitrix/main.site.selector/dropdown1/template.php заменить вывод названия языка на тип языка
С <?=$arSite["NAME"]?> на <?=$arSite["LANG"]?>  

Добавим копонент переключателя сайта в
- local/templates/ex2_multilang_template_materials/header.php
- local/templates/furniture_dark-blue/header.php

<div class="content-block-inner">
	<h3><?= GetMessage('CFT_LANG_CANGE') ?></h3>
	<? $APPLICATION->IncludeComponent(
		"bitrix:main.site.selector",
		"dropdown1",
		array(
			"CACHE_TIME" => "3600",	// Время кеширования (сек.)
			"CACHE_TYPE" => "A",	// Тип кеширования
			"SITE_LIST" => "",	// Список сайтов
			"COMPONENT_TEMPLATE" => "dropdown"
		),
		false
	); ?>
</div>

Добавить в local/templates/furniture_dark-blue/lang/ru/header.php фразу
$MESS["CFT_LANG_CANGE"] = "Выберите язык";

Добавить верхнее меню в ex2/site2/.top.menu.php

Array(
	"Main", 
	"/ex2/site2/", 
	Array(), 
	Array(), 
	"" 
),
Array(
	"About", 
	"/ex2/site2/about.php", 
	Array(), 
	Array(), 
	"" 
)

Копируем из задания ex2/site2/about.php

Проверяем работу в публичной части

------------------------------------------------------------------------------------------------------------

[ex2-104] Сбор жалоб на новости, на AJAX

